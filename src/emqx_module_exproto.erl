%%%-------------------------------------------------------------------
%%% @author root
%%% @copyright (C) 2020, <COMPANY>
%%% @doc
%%%
%%% @end
%%% Created : 29. 12月 2020 下午7:36
%%%-------------------------------------------------------------------
-module(emqx_module_exproto).
-author("root").

-include("../include/emqx_module_spec_listener.hrl").

-export([on_module_create/2, on_module_update/4,
  on_module_destroy/2, on_module_status/2]).

-module_type(#{create => on_module_create,
  description =>
  #{en =>
  <<84, 104, 101, 32, 69, 120, 116, 101, 110, 115, 105,
    111, 110, 32, 80, 114, 111, 116, 111, 99, 111, 108,
    32, 102, 111, 114, 32, 109, 117, 108, 116, 105, 112,
    108, 101, 32, 108, 97, 110, 103, 117, 97, 103, 101,
    32, 115, 117, 112, 112, 111, 114, 116, 101, 100>>,
    zh =>
    <<229, 164, 154, 232, 175, 173, 232, 168, 128, 230,
      137, 169, 229, 177, 149, 229, 141, 143, 232, 174,
      174, 230, 142, 165, 229, 133, 165>>},
  destroy => on_module_destroy, name => exproto,
  params =>
  #{cacertfile =>
  #{default => <<>>,
    description =>
    #{en =>
    <<67, 65, 32, 67, 101, 114, 116, 105, 102,
      105, 99, 97, 116, 101, 32, 70, 105, 108,
      101>>,
      zh =>
      <<67, 65, 32, 232, 175, 129, 228, 185, 166,
        230, 150, 135, 228, 187, 182>>},
    order => 5,
    title =>
    #{en =>
    <<67, 65, 32, 67, 101, 114, 116, 105, 102,
      105, 99, 97, 116, 101, 32, 70, 105, 108,
      101>>,
      zh =>
      <<67, 65, 32, 232, 175, 129, 228, 185, 166,
        230, 150, 135, 228, 187, 182>>},
    type => file},
    certfile =>
    #{default => <<>>,
      description =>
      #{en =>
      <<67, 101, 114, 116, 105, 102, 105, 99, 97,
        116, 101, 32, 70, 105, 108, 101>>,
        zh =>
        <<83, 83, 76, 32, 232, 175, 129, 228, 185,
          166, 230, 150, 135, 228, 187, 182>>},
      order => 4,
      title =>
      #{en =>
      <<67, 101, 114, 116, 105, 102, 105, 99, 97,
        116, 101, 32, 70, 105, 108, 101>>,
        zh =>
        <<232, 175, 129, 228, 185, 166, 230, 150,
          135, 228, 187, 182>>},
      type => file},
    keyfile =>
    #{default => <<>>,
      description =>
      #{en => <<75, 101, 121, 32, 70, 105, 108, 101>>,
        zh =>
        <<83, 83, 76, 32, 231, 167, 129, 233, 146,
          165, 230, 150, 135, 228, 187, 182>>},
      order => 3,
      title =>
      #{en => <<75, 101, 121, 32, 70, 105, 108, 101>>,
        zh =>
        <<231, 167, 129, 233, 146, 165, 230, 150,
          135, 228, 187, 182>>},
      type => file},
    listener =>
    #{common =>
    #{acceptors =>
    #{default => 8,
      description =>
      #{en =>
      <<84, 104, 101, 32, 110, 117,
        109, 98, 101, 114, 32, 111,
        102, 32, 97, 99, 99, 101,
        111, 112, 116, 111, 114, 115,
        44, 32, 73, 116, 32, 106,
        117, 115, 116, 32, 119, 111,
        114, 107, 115, 32, 102, 111,
        114, 32, 84, 67, 80, 47, 83,
        83, 76, 47, 68, 84, 76, 83,
        32, 115, 111, 99, 107, 101,
        116>>,
        zh =>
        <<230, 142, 165, 230, 148, 182,
          229, 153, 168, 230, 149, 176,
          233, 135, 143, 239, 188, 140,
          230, 137, 167, 232, 161, 140,
          32, 97, 99, 99, 101, 112,
          116, 32, 230, 147, 141, 228,
          189, 156, 231, 154, 132, 232,
          191, 155, 231, 168, 139, 230,
          149, 176, 233, 135, 143, 239,
          188, 140, 228, 187, 133, 229,
          175, 185, 32, 84, 67, 80, 47,
          83, 83, 76, 47, 68, 84, 76,
          83, 32, 83, 111, 99, 107,
          101, 116, 32, 230, 156, 137,
          230, 149, 136>>},
      order => 1, required => true,
      title =>
      #{en =>
      <<65, 99, 99, 101, 112, 116,
        111, 114, 115>>,
        zh =>
        <<230, 142, 165, 230, 148, 182,
          229, 153, 168, 230, 149, 176,
          233, 135, 143>>},
      type => number},
      active_n =>
      #{default => 100,
        description =>
        #{en =>
        <<83, 112, 101, 99, 105, 102,
          121, 32, 116, 104, 101, 32,
          123, 97, 99, 116, 105, 118,
          101, 44, 32, 78, 125, 32,
          111, 112, 116, 105, 111, 110,
          32, 102, 111, 114, 32, 116,
          104, 101, 32, 83, 111, 99,
          107, 101, 116>>,
          zh =>
          <<232, 174, 190, 231, 189, 174,
            32, 83, 111, 99, 107, 101,
            116, 32, 231, 154, 132, 32,
            123, 97, 99, 116, 105, 118,
            101, 44, 32, 78, 125, 32,
            233, 128, 137, 233, 161,
            185>>},
        order => 2, required => true,
        title =>
        #{en =>
        <<65, 99, 116, 105, 118, 101,
          78>>,
          zh =>
          <<65, 99, 116, 105, 118, 101,
            78>>},
        type => number},
      max_conn_rate =>
      #{default => 1000,
        description =>
        #{en =>
        <<65, 108, 108, 111, 119, 101,
          100, 32, 99, 111, 110, 110,
          101, 99, 116, 105, 111, 110,
          115, 32, 112, 101, 114, 32,
          115, 101, 99, 111, 110,
          100>>,
          zh =>
          <<232, 175, 165, 231, 155, 145,
            229, 144, 172, 229, 153, 168,
            230, 175, 143, 231, 167, 146,
            229, 133, 129, 232, 174, 184,
            231, 154, 132, 230, 156, 128,
            229, 164, 167, 232, 191, 158,
            230, 142, 165, 228, 184, 170,
            230, 149, 176>>},
        order => 3, required => false,
        title =>
        #{en =>
        <<77, 97, 120, 32, 67, 111,
          110, 110, 101, 99, 116, 105,
          111, 110, 32, 82, 97, 116,
          101>>,
          zh =>
          <<230, 156, 128, 229, 164, 167,
            232, 191, 158, 230, 142, 165,
            233, 128, 159, 231, 142,
            135>>},
        type => number},
      max_connections =>
      #{default => 1000000,
        description =>
        #{en =>
        <<84, 104, 101, 32, 109, 97,
          120, 105, 109, 117, 109, 32,
          99, 111, 110, 110, 101, 99,
          116, 105, 111, 110, 115, 32,
          111, 102, 32, 108, 105, 115,
          116, 101, 110, 101, 114>>,
          zh =>
          <<232, 175, 165, 231, 155, 145,
            229, 144, 172, 229, 153, 168,
            229, 133, 129, 232, 174, 184,
            231, 154, 132, 230, 156, 128,
            229, 164, 167, 232, 191, 158,
            230, 142, 165, 230, 149,
            176>>},
        order => 4, required => false,
        title =>
        #{en =>
        <<77, 97, 120, 32, 67, 111,
          110, 110, 101, 99, 116, 105,
          111, 110, 115>>,
          zh =>
          <<230, 156, 128, 229, 164, 167,
            232, 191, 158, 230, 142, 165,
            230, 149, 176>>},
        type => number},
      proxy_protocol =>
      #{default => false,
        description =>
        #{en =>
        <<69, 110, 97, 98, 108, 101,
          32, 116, 104, 101, 32, 80,
          114, 111, 120, 121, 32, 80,
          114, 111, 116, 111, 99, 111,
          108, 32, 86, 49, 47, 50, 32,
          105, 102, 32, 116, 104, 101,
          32, 69, 77, 81, 32, 88, 32,
          99, 108, 117, 115, 116, 101,
          114, 32, 105, 115, 32, 100,
          101, 112, 108, 111, 121, 101,
          100, 32, 98, 101, 104, 105,
          110, 100, 32, 72, 65, 80,
          114, 111, 120, 121, 32, 111,
          114, 32, 78, 103, 105, 110,
          120>>,
          zh =>
          <<229, 188, 128, 229, 144, 175,
            32, 80, 114, 111, 120, 121,
            32, 80, 114, 111, 116, 111,
            99, 111, 108, 32, 86, 49, 47,
            50, 239, 188, 140, 229, 166,
            130, 230, 158, 156, 32, 69,
            77, 81, 32, 88, 32, 233, 155,
            134, 231, 190, 164, 233, 131,
            168, 231, 189, 178, 229, 156,
            168, 32, 72, 65, 80, 114,
            111, 120, 121, 32, 230, 136,
            150, 32, 78, 103, 105, 110,
            120, 32, 229, 144, 142>>},
        order => 5, required => false,
        title =>
        #{en =>
        <<80, 114, 111, 120, 121, 32,
          80, 114, 111, 116, 111, 99,
          111, 108>>,
          zh =>
          <<229, 188, 128, 229, 144, 175,
            32, 80, 114, 111, 120, 121,
            32, 80, 114, 111, 116, 111,
            99, 111, 108>>},
        type => boolean},
      proxy_protocol_timeout =>
      #{default => 3000,
        description =>
        #{en =>
        <<84, 104, 101, 32, 116, 105,
          109, 101, 111, 117, 116, 32,
          102, 111, 114, 32, 97, 99,
          99, 101, 112, 116, 105, 110,
          103, 32, 112, 114, 111, 120,
          121, 32, 112, 114, 111, 116,
          111, 99, 111, 108, 44, 32,
          69, 77, 81, 32, 88, 32, 119,
          105, 108, 108, 32, 99, 108,
          111, 115, 101, 32, 116, 104,
          101, 32, 84, 67, 80, 32, 99,
          111, 110, 110, 101, 99, 116,
          105, 111, 110, 32, 105, 102,
          32, 110, 111, 32, 112, 114,
          111, 120, 121, 32, 112, 114,
          111, 116, 111, 99, 111, 108,
          32, 112, 97, 99, 107, 101,
          116, 32, 114, 101, 99, 101,
          118, 105, 101, 100, 32, 119,
          105, 116, 104, 105, 110, 32,
          116, 104, 101, 32, 116, 105,
          109, 101, 111, 117, 116>>,
          zh =>
          <<229, 164, 132, 231, 144, 134,
            32, 80, 114, 111, 120, 121,
            32, 80, 114, 111, 116, 111,
            99, 111, 108, 32, 231, 154,
            132, 232, 182, 133, 230, 151,
            182, 230, 151, 182, 233, 151,
            180, 239, 188, 140, 229, 166,
            130, 230, 158, 156, 232, 182,
            133, 232, 191, 135, 232, 175,
            165, 230, 151, 182, 233, 151,
            180, 230, 156, 170, 230, 148,
            182, 229, 136, 176, 32, 80,
            114, 111, 120, 121, 32, 80,
            114, 111, 116, 111, 99, 111,
            108, 32, 231, 154, 132, 230,
            138, 165, 230, 150, 135, 239,
            188, 140, 69, 77, 81, 32, 88,
            32, 229, 176, 134, 229, 133,
            179, 233, 151, 173, 232, 175,
            165, 32, 84, 67, 80, 32, 232,
            191, 158, 230, 142, 165>>},
        order => 6, required => false,
        title =>
        #{en =>
        <<80, 114, 111, 120, 121, 32,
          80, 114, 111, 116, 111, 99,
          111, 108, 32, 84, 105, 109,
          101, 111, 117, 116>>,
          zh =>
          <<80, 114, 111, 120, 121, 32,
            80, 114, 111, 116, 111, 99,
            111, 108, 32, 229, 164, 132,
            231, 144, 134, 232, 182, 133,
            230, 151, 182, 230, 151, 182,
            233, 151, 180>>},
        type => number},
      recbuf =>
      #{default => 2048,
        description =>
        #{en =>
        <<84, 104, 101, 32, 114, 101,
          99, 101, 105, 118, 101, 32,
          98, 117, 102, 102, 101, 114,
          32, 111, 102, 32, 115, 111,
          99, 107, 101, 116, 32, 40,
          111, 115, 32, 107, 101, 114,
          110, 101, 108, 41>>,
          zh =>
          <<83, 111, 99, 107, 101, 116,
            32, 230, 142, 165, 230, 148,
            182, 231, 188, 147, 229, 134,
            178, 229, 140, 186, 229, 164,
            167, 229, 176, 143, 32, 40,
            230, 147, 141, 228, 189, 156,
            231, 179, 187, 231, 187, 159,
            229, 134, 133, 230, 160, 184,
            231, 186, 167, 41>>},
        order => 8, required => false,
        title =>
        #{en =>
        <<82, 101, 99, 101, 105, 118,
          101, 32, 66, 117, 102, 102,
          101, 114>>,
          zh =>
          <<230, 142, 165, 230, 148, 182,
            231, 188, 147, 229, 134, 178,
            229, 140, 186>>},
        type => number},
      reuseaddr =>
      #{default => true,
        description =>
        #{en =>
        <<84, 104, 101, 32, 83, 79, 95,
          82, 69, 85, 83, 69, 65, 68,
          68, 82, 32, 102, 108, 97,
          103, 32, 102, 111, 114, 32,
          108, 105, 115, 116, 101, 110,
          101, 114>>,
          zh =>
          <<232, 174, 190, 231, 189, 174,
            32, 83, 111, 99, 107, 101,
            116, 32, 231, 154, 132, 32,
            83, 79, 95, 82, 69, 85, 83,
            69, 65, 68, 68, 82, 32, 230,
            160, 135, 232, 175, 134>>},
        order => 9, required => false,
        title =>
        #{en =>
        <<83, 79, 95, 82, 69, 85, 83,
          69, 65, 68, 68, 82, 32, 70,
          108, 97, 103>>,
          zh =>
          <<83, 79, 95, 82, 69, 85, 83,
            69, 65, 68, 68, 82, 32, 230,
            160, 135, 232, 175, 134>>},
        type => boolean},
      sndbuf =>
      #{default => 2048,
        description =>
        #{en =>
        <<84, 104, 101, 32, 115, 101,
          110, 100, 32, 98, 117, 102,
          102, 101, 114, 32, 111, 102,
          32, 115, 111, 99, 107, 101,
          116, 32, 40, 111, 115, 32,
          107, 101, 114, 110, 101, 108,
          41>>,
          zh =>
          <<83, 111, 99, 107, 101, 116,
            32, 229, 143, 145, 233, 128,
            129, 231, 188, 147, 229, 134,
            178, 229, 140, 186, 229, 164,
            167, 229, 176, 143, 32, 40,
            230, 147, 141, 228, 189, 156,
            231, 179, 187, 231, 187, 159,
            229, 134, 133, 230, 160, 184,
            231, 186, 167, 41>>},
        order => 7, required => false,
        title =>
        #{en =>
        <<83, 101, 110, 100, 32, 66,
          117, 102, 102, 101, 114>>,
          zh =>
          <<229, 143, 145, 233, 128, 129,
            231, 188, 147, 229, 134, 178,
            229, 140, 186>>},
        type => number}},
      dtls_options =>
      #{cacertfile =>
      #{default => <<>>,
        description =>
        #{en =>
        <<84, 104, 101, 32, 67, 65, 32,
          99, 101, 114, 116, 105, 102,
          105, 99, 97, 116, 101, 32,
          102, 105, 108, 101, 32, 112,
          97, 116, 104>>,
          zh =>
          <<67, 65, 32, 232, 175, 129,
            228, 185, 166, 230, 150, 135,
            228, 187, 182, 232, 183, 175,
            229, 190, 132>>},
        order => 6, required => false,
        title =>
        #{en =>
        <<67, 65, 32, 67, 101, 114,
          116, 102, 105, 108, 101>>,
          zh =>
          <<67, 65, 32, 232, 175, 129,
            228, 185, 166, 230, 150, 135,
            228, 187, 182>>},
        type => file},
        certfile =>
        #{default => <<>>,
          description =>
          #{en =>
          <<84, 104, 101, 32, 99, 101,
            114, 116, 105, 102, 105, 99,
            97, 116, 101, 32, 102, 105,
            108, 101, 32, 112, 97, 116,
            104>>,
            zh =>
            <<232, 175, 129, 228, 185, 166,
              232, 183, 175, 229, 190,
              132>>},
          order => 4, required => false,
          title =>
          #{en =>
          <<67, 101, 114, 116, 102, 105,
            108, 101>>,
            zh =>
            <<232, 175, 129, 228, 185, 166,
              230, 150, 135, 228, 187,
              182>>},
          type => file},
        ciphers =>
        #{default =>
        <<100, 101, 102, 97, 117, 108, 116>>,
          description => #{en => <<>>, zh => <<>>},
          enum =>
          [<<100, 101, 102, 97, 117, 108,
            116>>,
            <<112, 115, 107>>],
          order => 2, required => true,
          title =>
          #{en =>
          <<67, 105, 112, 104, 101, 114,
            115>>,
            zh =>
            <<229, 138, 160, 229, 175, 134,
              229, 165, 151, 228, 187,
              182>>},
          type => string},
        fail_if_no_peer_cert =>
        #{default => false,
          description => #{en => <<>>, zh => <<>>},
          order => 7, required => false,
          title =>
          #{en =>
          <<102, 97, 105, 108, 95, 105,
            102, 95, 110, 111, 95, 112,
            101, 101, 114, 95, 99, 101,
            114, 116>>,
            zh =>
            <<229, 133, 179, 233, 151, 173,
              230, 151, 160, 232, 175, 129,
              228, 185, 166, 229, 174, 162,
              230, 136, 183, 231, 171, 175,
              232, 191, 158, 230, 142,
              165>>},
          type => boolean},
        keyfile =>
        #{default => <<>>,
          description =>
          #{en =>
          <<84, 104, 101, 32, 75, 101,
            121, 32, 102, 105, 108, 101,
            32, 112, 97, 116, 104>>,
            zh =>
            <<231, 167, 152, 233, 146, 165,
              230, 150, 135, 228, 187, 182,
              232, 183, 175, 229, 190,
              132>>},
          order => 5, required => false,
          title =>
          #{en =>
          <<75, 101, 121, 102, 105, 108,
            101>>,
            zh =>
            <<229, 175, 134, 233, 146, 165,
              230, 150, 135, 228, 187,
              182>>},
          type => file},
        verify =>
        #{default =>
        <<118, 101, 114, 105, 102, 121, 95,
          110, 111, 110, 101>>,
          description => #{en => <<>>, zh => <<>>},
          enum =>
          [<<118, 101, 114, 105, 102, 121, 95,
            110, 111, 110, 101>>,
            <<118, 101, 114, 105, 102, 121, 95,
              112, 101, 101, 114>>],
          order => 3, required => true,
          title =>
          #{en =>
          <<86, 101, 114, 105, 102,
            121>>,
            zh =>
            <<230, 160, 161, 233, 170, 140,
              231, 177, 187, 229, 158,
              139>>},
          type => string},
        versions =>
        #{default =>
        <<100, 116, 108, 115, 118, 49, 46,
          50, 44, 100, 116, 108, 115, 118,
          49>>,
          description => #{en => <<>>, zh => <<>>},
          enum =>
          [<<100, 116, 108, 115, 118, 49, 46,
            50, 44, 100, 116, 108, 115, 118,
            49>>,
            <<100, 116, 108, 115, 118, 49, 46,
              50>>,
            <<100, 116, 108, 115, 118, 49>>],
          order => 1, required => true,
          title =>
          #{en =>
          <<68, 84, 76, 83, 32, 86, 101,
            114, 115, 105, 111, 110>>,
            zh =>
            <<68, 84, 76, 83, 32, 229, 141,
              143, 232, 174, 174, 231, 137,
              136, 230, 156, 172>>},
          type => string}},
      protocol =>
      #{connection_handler_cacertfile =>
      #{default => <<>>,
        description =>
        #{en =>
        <<84, 104, 101, 32, 67, 65, 32,
          67, 101, 114, 116, 102, 105,
          99, 97, 116, 101, 32, 102,
          105, 108, 101, 32, 116, 111,
          32, 118, 101, 114, 105, 102,
          121, 32, 116, 104, 101, 32,
          115, 101, 108, 102, 45, 115,
          105, 103, 110, 101, 100, 32,
          83, 83, 76, 32, 99, 101, 114,
          116, 105, 102, 105, 99, 97,
          116, 101, 32, 105, 110, 32,
          116, 104, 101, 32, 72, 84,
          84, 80, 83, 32, 67, 111, 110,
          110, 101, 99, 116, 105, 111,
          110, 72, 97, 110, 100, 108,
          101, 114, 32, 115, 101, 114,
          118, 101, 114>>,
          zh =>
          <<67, 65, 32, 232, 175, 129,
            228, 185, 166, 230, 150, 135,
            228, 187, 182, 227, 128, 130,
            231, 148, 168, 228, 186, 142,
            233, 170, 140, 232, 175, 129,
            232, 191, 158, 230, 142, 165,
            229, 164, 132, 231, 144, 134,
            230, 156, 141, 229, 138, 161,
            229, 153, 168, 231, 154, 132,
            232, 135, 170, 231, 173, 190,
            229, 144, 141, 32, 83, 83,
            76, 32, 232, 175, 129, 228,
            185, 166>>},
        order => 6, required => false,
        title =>
        #{en =>
        <<72, 97, 110, 100, 108, 101,
          114, 39, 115, 32, 83, 83, 76,
          32, 67, 65, 32, 67, 101, 114,
          116, 102, 105, 108, 101>>,
          zh =>
          <<229, 164, 132, 231, 144, 134,
            229, 153, 168, 32, 83, 83,
            76, 32, 67, 65, 32, 232, 175,
            129, 228, 185, 166, 230, 150,
            135, 228, 187, 182>>},
        type => file},
        connection_handler_certfile =>
        #{default => <<>>,
          description =>
          #{en =>
          <<84, 104, 101, 32, 67, 101,
            114, 116, 105, 102, 105, 99,
            97, 116, 101, 32, 102, 105,
            108, 101, 32, 102, 111, 114,
            32, 101, 115, 116, 97, 98,
            108, 105, 115, 104, 105, 110,
            103, 32, 97, 32, 84, 119,
            111, 45, 87, 97, 121, 32, 83,
            83, 76, 32, 99, 111, 110,
            110, 101, 99, 116, 105, 111,
            110, 32, 116, 111, 32, 116,
            104, 101, 32, 72, 84, 84, 80,
            83, 32, 67, 111, 110, 110,
            101, 99, 116, 105, 111, 110,
            72, 97, 110, 100, 108, 101,
            114, 32, 115, 101, 114, 118,
            101, 114>>,
            zh =>
            <<231, 148, 168, 228, 186, 142,
              229, 144, 145, 32, 72, 84,
              84, 80, 83, 32, 231, 154,
              132, 232, 191, 158, 230, 142,
              165, 229, 164, 132, 231, 144,
              134, 230, 156, 141, 229, 138,
              161, 229, 153, 168, 229, 187,
              186, 231, 171, 139, 229, 143,
              140, 229, 144, 145, 32, 83,
              83, 76, 32, 232, 191, 158,
              230, 142, 165, 231, 154, 132,
              229, 174, 162, 230, 136, 183,
              231, 171, 175, 232, 175, 129,
              228, 185, 166, 230, 150, 135,
              228, 187, 182>>},
          order => 5, required => false,
          title =>
          #{en =>
          <<72, 97, 110, 100, 108, 101,
            114, 39, 115, 32, 83, 83, 76,
            32, 67, 101, 114, 116, 105,
            102, 105, 108, 101>>,
            zh =>
            <<229, 164, 132, 231, 144, 134,
              229, 153, 168, 32, 83, 83,
              76, 32, 232, 175, 129, 228,
              185, 166, 230, 150, 135, 228,
              187, 182>>},
          type => file},
        connection_handler_keyfile =>
        #{default => <<>>,
          description =>
          #{en =>
          <<84, 104, 101, 32, 75, 101,
            121, 32, 102, 105, 108, 101,
            32, 102, 111, 114, 32, 101,
            115, 116, 97, 98, 108, 105,
            115, 104, 105, 110, 103, 32,
            97, 32, 84, 119, 111, 45, 87,
            97, 121, 32, 83, 83, 76, 32,
            99, 111, 110, 110, 101, 99,
            116, 105, 111, 110, 32, 116,
            111, 32, 116, 104, 101, 32,
            72, 84, 84, 80, 83, 32, 67,
            111, 110, 110, 101, 99, 116,
            105, 111, 110, 72, 97, 110,
            100, 108, 101, 114, 32, 115,
            101, 114, 118, 101, 114>>,
            zh =>
            <<231, 148, 168, 228, 186, 142,
              229, 144, 145, 32, 72, 84,
              84, 80, 83, 32, 231, 154,
              132, 232, 191, 158, 230, 142,
              165, 229, 164, 132, 231, 144,
              134, 230, 156, 141, 229, 138,
              161, 229, 153, 168, 229, 187,
              186, 231, 171, 139, 229, 143,
              140, 229, 144, 145, 32, 83,
              83, 76, 32, 232, 191, 158,
              230, 142, 165, 231, 154, 132,
              229, 174, 162, 230, 136, 183,
              231, 171, 175, 229, 175, 134,
              233, 146, 165, 230, 150, 135,
              228, 187, 182>>},
          order => 4, required => false,
          title =>
          #{en =>
          <<72, 97, 110, 100, 108, 101,
            114, 39, 115, 32, 83, 83, 76,
            32, 75, 101, 121, 32, 70,
            105, 108, 101>>,
            zh =>
            <<229, 164, 132, 231, 144, 134,
              229, 153, 168, 32, 83, 83,
              76, 32, 229, 175, 134, 233,
              146, 165, 230, 150, 135, 228,
              187, 182>>},
          type => file},
        connection_handler_url =>
        #{default =>
        <<104, 116, 116, 112, 58, 47, 47, 49,
          50, 55, 46, 48, 46, 48, 46, 49, 58,
          57, 48, 48, 49>>,
          description =>
          #{en =>
          <<84, 104, 101, 32, 85, 82, 76,
            32, 97, 100, 100, 114, 101,
            115, 115, 32, 102, 111, 114,
            32, 67, 111, 110, 110, 101,
            99, 116, 105, 111, 110, 72,
            97, 110, 100, 108, 101, 114,
            32, 115, 101, 114, 118, 101,
            114>>,
            zh =>
            <<232, 191, 158, 230, 142, 165,
              229, 164, 132, 231, 144, 134,
              230, 156, 141, 229, 138, 161,
              229, 153, 168, 231, 154, 132,
              32, 85, 82, 76, 32, 229, 156,
              176, 229, 157, 128>>},
          order => 3, required => true,
          title =>
          #{en =>
          <<72, 97, 110, 100, 108, 101,
            114, 32, 83, 101, 114, 118,
            101, 114, 32, 65, 100, 100,
            114, 101, 115, 115>>,
            zh =>
            <<229, 164, 132, 231, 144, 134,
              229, 153, 168, 230, 156, 141,
              229, 138, 161, 229, 156, 176,
              229, 157, 128>>},
          type => string},
        listen_on =>
        #{default =>
        <<48, 46, 48, 46, 48, 46, 48, 58, 55,
          57, 57, 51>>,
          description => #{en => <<>>, zh => <<>>},
          order => 1, required => true,
          title =>
          #{en =>
          <<76, 105, 115, 116, 101, 110,
            101, 114>>,
            zh =>
            <<231, 155, 145, 229, 144, 172,
              229, 156, 176, 229, 157,
              128>>},
          type => string},
        listener_type =>
        #{default => <<116, 99, 112>>,
          description => #{en => <<>>, zh => <<>>},
          enum =>
          [<<116, 99, 112>>, <<115, 115, 108>>,
            <<117, 100, 112>>,
            <<100, 116, 108, 115>>],
          order => 2, required => true,
          title =>
          #{en =>
          <<76, 105, 115, 116, 101, 110,
            101, 114, 32, 84, 121, 112,
            101>>,
            zh =>
            <<231, 155, 145, 229, 144, 172,
              231, 177, 187, 229, 158,
              139>>},
          type => string}},
      ssl_options =>
      #{cacertfile =>
      #{default => <<>>,
        description =>
        #{en =>
        <<84, 104, 101, 32, 67, 65, 32,
          99, 101, 114, 116, 105, 102,
          105, 99, 97, 116, 101, 32,
          102, 105, 108, 101, 32, 112,
          97, 116, 104>>,
          zh =>
          <<67, 65, 32, 232, 175, 129,
            228, 185, 166, 230, 150, 135,
            228, 187, 182, 232, 183, 175,
            229, 190, 132>>},
        order => 7, required => false,
        title =>
        #{en =>
        <<67, 65, 32, 67, 101, 114,
          116, 102, 105, 108, 101>>,
          zh =>
          <<67, 65, 32, 232, 175, 129,
            228, 185, 166, 230, 150, 135,
            228, 187, 182>>},
        type => file},
        certfile =>
        #{default => <<>>,
          description =>
          #{en =>
          <<84, 104, 101, 32, 99, 101,
            114, 116, 105, 102, 105, 99,
            97, 116, 101, 32, 102, 105,
            108, 101, 32, 112, 97, 116,
            104>>,
            zh =>
            <<232, 175, 129, 228, 185, 166,
              230, 150, 135, 228, 187, 182,
              232, 183, 175, 229, 190,
              132>>},
          order => 5, required => false,
          title =>
          #{en =>
          <<67, 101, 114, 116, 102, 105,
            108, 101>>,
            zh =>
            <<232, 175, 129, 228, 185, 166,
              230, 150, 135, 228, 187,
              182>>},
          type => file},
        ciphers =>
        #{default =>
        <<100, 101, 102, 97, 117, 108, 116>>,
          description => #{en => <<>>, zh => <<>>},
          enum =>
          [<<100, 101, 102, 97, 117, 108,
            116>>,
            <<112, 115, 107>>],
          order => 2, required => true,
          title =>
          #{en =>
          <<67, 105, 112, 104, 101, 114,
            115>>,
            zh =>
            <<229, 138, 160, 229, 175, 134,
              229, 165, 151, 228, 187,
              182>>},
          type => string},
        fail_if_no_peer_cert =>
        #{default => false,
          description => #{en => <<>>, zh => <<>>},
          order => 8, required => false,
          title =>
          #{en =>
          <<102, 97, 105, 108, 95, 105,
            102, 95, 110, 111, 95, 112,
            101, 101, 114, 95, 99, 101,
            114, 116>>,
            zh =>
            <<229, 133, 179, 233, 151, 173,
              230, 151, 160, 232, 175, 129,
              228, 185, 166, 229, 174, 162,
              230, 136, 183, 231, 171, 175,
              232, 191, 158, 230, 142,
              165>>},
          type => boolean},
        handshake_timeout =>
        #{default => 15000,
          description => #{en => <<>>, zh => <<>>},
          order => 3, required => false,
          title =>
          #{en =>
          <<72, 97, 110, 100, 115, 104,
            97, 107, 101, 32, 84, 105,
            109, 101, 111, 117, 116>>,
            zh =>
            <<230, 143, 161, 230, 137, 139,
              232, 182, 133, 230, 151, 182,
              230, 151, 182, 233, 151,
              180>>},
          type => number},
        keyfile =>
        #{default => <<>>,
          description =>
          #{en =>
          <<84, 104, 101, 32, 75, 101,
            121, 32, 102, 105, 108, 101,
            32, 112, 97, 116, 104>>,
            zh =>
            <<231, 167, 152, 233, 146, 165,
              230, 150, 135, 228, 187, 182,
              232, 183, 175, 229, 190,
              132>>},
          order => 6, required => false,
          title =>
          #{en =>
          <<75, 101, 121, 102, 105, 108,
            101>>,
            zh =>
            <<229, 175, 134, 233, 146, 165,
              230, 150, 135, 228, 187,
              182>>},
          type => file},
        verify =>
        #{default =>
        <<118, 101, 114, 105, 102, 121, 95,
          110, 111, 110, 101>>,
          description => #{en => <<>>, zh => <<>>},
          enum =>
          [<<118, 101, 114, 105, 102, 121, 95,
            110, 111, 110, 101>>,
            <<118, 101, 114, 105, 102, 121, 95,
              112, 101, 101, 114>>],
          order => 4, required => true,
          title =>
          #{en =>
          <<86, 101, 114, 105, 102,
            121>>,
            zh =>
            <<230, 160, 161, 233, 170, 140,
              231, 177, 187, 229, 158,
              139>>},
          type => string},
        versions =>
        #{default =>
        <<116, 108, 115, 118, 49, 46, 50, 44,
          116, 108, 115, 118, 49, 46, 49, 44,
          116, 108, 115, 118, 49>>,
          description => #{en => <<>>, zh => <<>>},
          enum =>
          [<<116, 108, 115, 118, 49, 46, 50,
            44, 116, 108, 115, 118, 49, 46,
            49, 44, 116, 108, 115, 118, 49>>,
            <<116, 108, 115, 118, 49, 46, 50>>,
            <<116, 108, 115, 118, 49, 46, 50,
              44, 116, 108, 115, 118, 49, 46,
              49>>,
            <<116, 108, 115, 118, 49>>],
          order => 1, required => true,
          title =>
          #{en =>
          <<84, 76, 83, 32, 86, 101, 114,
            115, 105, 111, 110>>,
            zh =>
            <<84, 76, 83, 32, 231, 137,
              136, 230, 156, 172>>},
          type => string}},
      tcp_options =>
      #{backlog =>
      #{default => 1000,
        description =>
        #{en =>
        <<84, 104, 101, 32, 84, 67, 80,
          32, 98, 97, 99, 107, 108,
          111, 103, 32, 100, 101, 102,
          105, 110, 101, 115, 32, 116,
          104, 101, 32, 109, 97, 120,
          105, 109, 117, 109, 32, 108,
          101, 110, 103, 116, 104, 32,
          116, 104, 97, 116, 32, 116,
          104, 101, 32, 113, 117, 101,
          117, 101, 32, 111, 102, 32,
          112, 101, 110, 100, 105, 110,
          103, 99, 111, 110, 110, 101,
          99, 116, 105, 111, 110, 115,
          32, 99, 97, 110, 32, 103,
          114, 111, 119, 32, 116,
          111>>,
          zh =>
          <<84, 67, 80, 32, 232, 191,
            158, 230, 142, 165, 233, 152,
            159, 229, 136, 151, 230, 156,
            128, 229, 164, 167, 233, 149,
            191, 229, 186, 166>>},
        order => 1, required => false,
        title =>
        #{en =>
        <<66, 97, 99, 107, 108, 111,
          103>>,
          zh =>
          <<84, 67, 80, 32, 232, 191,
            158, 230, 142, 165, 233, 152,
            159, 229, 136, 151, 233, 149,
            191, 229, 186, 166>>},
        type => number},
        nodelay =>
        #{default => true,
          description =>
          #{en =>
          <<84, 104, 101, 32, 84, 67, 80,
            95, 78, 79, 68, 69, 76, 65,
            89, 32, 102, 108, 97, 103,
            32, 102, 111, 114, 32, 77,
            81, 84, 84, 32, 99, 111, 110,
            110, 101, 99, 116, 105, 111,
            110, 115, 46, 32, 83, 109,
            97, 108, 108, 32, 97, 109,
            111, 117, 110, 116, 115, 32,
            111, 102, 32, 100, 97, 116,
            97, 32, 97, 114, 101, 32,
            115, 101, 110, 116, 32, 105,
            109, 109, 101, 100, 105, 97,
            116, 101, 108, 121, 32, 105,
            102, 32, 116, 104, 101, 32,
            111, 112, 116, 105, 111, 110,
            32, 105, 115, 32, 101, 110,
            97, 98, 108, 101, 100, 32,
            84, 104, 101, 32, 84, 67, 80,
            32, 98, 97, 99, 107, 108,
            111, 103, 32, 100, 101, 102,
            105, 110, 101, 115, 32, 116,
            104, 101, 32, 109, 97, 120,
            105, 109, 117, 109, 32, 108,
            101, 110, 103, 116, 104, 32,
            116, 104, 97, 116, 32, 116,
            104, 101, 32, 113, 117, 101,
            117, 101, 32, 111, 102, 32,
            112, 101, 110, 100, 105, 110,
            103>>,
            zh =>
            <<232, 174, 190, 231, 189, 174,
              32, 84, 67, 80, 95, 78, 79,
              68, 69, 76, 65, 89, 32, 230,
              160, 135, 232, 175, 134>>},
          order => 4, required => false,
          title =>
          #{en =>
          <<84, 67, 80, 95, 78, 79, 68,
            69, 76, 65, 89, 32, 70, 108,
            97, 103>>,
            zh =>
            <<84, 67, 80, 95, 78, 79, 68,
              69, 76, 65, 89, 32, 230, 160,
              135, 232, 175, 134>>},
          type => boolean},
        send_timeout =>
        #{default => 150000,
          description =>
          #{en =>
          <<84, 104, 101, 32, 84, 67, 80,
            32, 115, 101, 110, 100, 32,
            116, 105, 109, 101, 111, 117,
            116>>,
            zh =>
            <<84, 67, 80, 32, 230, 138,
              165, 230, 150, 135, 229, 143,
              145, 233, 128, 129, 232, 182,
              133, 230, 151, 182, 230, 151,
              182, 233, 151, 180>>},
          order => 2, required => false,
          title =>
          #{en =>
          <<83, 101, 110, 100, 32, 84,
            105, 109, 101, 111, 117,
            116>>,
            zh =>
            <<229, 143, 145, 233, 128, 129,
              232, 182, 133, 230, 151, 182,
              230, 151, 182, 233, 151,
              180>>},
          type => number},
        send_timeout_close =>
        #{default => true,
          description =>
          #{en =>
          <<67, 108, 111, 115, 101, 32,
            116, 104, 101, 32, 84, 67,
            80, 32, 99, 111, 110, 110,
            101, 99, 116, 105, 111, 110,
            32, 105, 102, 32, 115, 101,
            110, 100, 32, 116, 105, 109,
            101, 111, 117, 116>>,
            zh =>
            <<229, 133, 179, 233, 151, 173,
              229, 143, 145, 233, 128, 129,
              232, 182, 133, 230, 151, 182,
              231, 154, 132, 32, 84, 67,
              80, 32, 232, 191, 158, 230,
              142, 165>>},
          order => 3, required => false,
          title =>
          #{en =>
          <<83, 101, 110, 100, 32, 84,
            105, 109, 101, 111, 117, 116,
            32, 67, 108, 111, 115, 101>>,
            zh =>
            <<229, 133, 179, 233, 151, 173,
              229, 143, 145, 233, 128, 129,
              232, 182, 133, 230, 151, 182,
              232, 191, 158, 230, 142,
              165>>},
          type => boolean}},
      udp_options => #{}},
    port =>
    #{default => 9100,
      description =>
      #{en =>
      <<84, 104, 101, 32, 76, 105, 115, 116, 101,
        110, 32, 80, 111, 114, 116, 32, 102, 111,
        114, 32, 67, 111, 110, 110, 101, 99, 116,
        105, 111, 110, 65, 100, 97, 112, 116,
        101, 114, 32, 103, 82, 80, 67, 32, 115,
        101, 114, 118, 105, 99, 101, 46, 73, 116,
        32, 105, 115, 32, 117, 115, 101, 100, 32,
        116, 111, 32, 112, 114, 111, 118, 105,
        100, 101, 32, 65, 80, 73, 115, 32, 102,
        111, 114, 32, 101, 120, 116, 101, 114,
        110, 97, 108, 32, 99, 97, 108, 108,
        115>>,
        zh =>
        <<103, 82, 80, 67, 32, 67, 111, 110, 110,
          101, 99, 116, 105, 111, 110, 65, 100, 97,
          112, 116, 101, 114, 32, 230, 156, 141,
          229, 138, 161, 231, 154, 132, 231, 155,
          145, 229, 144, 172, 229, 156, 176, 229,
          157, 128, 227, 128, 130, 231, 148, 168,
          228, 186, 142, 230, 143, 144, 228, 190,
          155, 32, 65, 80, 73, 32, 228, 190, 155,
          229, 164, 150, 233, 131, 168, 232, 176,
          131, 231, 148, 168>>},
      order => 1, required => true,
      title =>
      #{en =>
      <<76, 105, 115, 116, 101, 110, 32, 80, 111,
        114, 116>>,
        zh =>
        <<231, 155, 145, 229, 144, 172, 231, 171,
          175, 229, 143, 163>>},
      type => number},
    ssl =>
    #{default => false,
      description =>
      #{en =>
      <<69, 110, 97, 98, 108, 101, 32, 83, 83,
        76>>,
        zh =>
        <<230, 152, 175, 229, 144, 166, 229, 188,
          128, 229, 144, 175, 32, 83, 83, 76>>},
      order => 2,
      title =>
      #{en =>
      <<69, 110, 97, 98, 108, 101, 32, 83, 83,
        76>>,
        zh =>
        <<229, 188, 128, 229, 144, 175, 32, 83, 83,
          76>>},
      type => boolean}},
  status => on_module_status,
  title =>
  #{en =>
  <<69, 120, 116, 101, 110, 115, 105, 111, 110, 32, 80,
    114, 111, 116, 111, 99, 111, 108>>,
    zh =>
    <<229, 164, 154, 232, 175, 173, 232, 168, 128, 230,
      137, 169, 229, 177, 149, 229, 141, 143, 232, 174,
      174, 230, 142, 165, 229, 133, 165>>},
  type => extension, update => on_module_update}).


on_module_create(ModId, Config) ->
  _ = application:ensure_all_started(grpc),
  PoolSize = emqx_vm:schedulers() * 2,
  Pool = emqx_pool_sup:spec([exproto_gcli_pool, hash,
    PoolSize, {emqx_exproto_gcli, start_link, []}]),
  emqx_modules_sup:start_child(Pool),
  {GRPCSvrPort, GRPCSvrSSLOptions} =
    grpc_server_options(ModId, Config),
  {ok, GRPCSvrPid} = start_grpc_server(ModId, GRPCSvrPort,
    GRPCSvrSSLOptions),
  Listeners =
    listeners_and_protocol_handler_options(ModId, Config),
  lists:foreach(fun ({Proto, LisType, ListenOn, Opts}) ->
    emqx_exproto:start_listener({Proto, LisType, ListenOn,
      Opts})
                end,
    Listeners),
  #{server => GRPCSvrPid, listeners => Listeners}.

on_module_update(_ModId, Params, Config, Config) ->
  Params;
on_module_update(ModId, Params, _OldConfig, Config) ->
  on_module_destroy(ModId, Params),
  on_module_create(ModId, Config).

on_module_destroy(ModId,
    #{server := GRPCSvrPid, listeners := Listeners}) ->
  _ = stop_grpc_server(ModId, GRPCSvrPid),
  lists:foreach(fun ({Proto, LisType, ListenOn, Opts}) ->
    ChannName = proplists:get_value(handler, Opts),
    _ = stop_grpc_connection_handler_instance(ChannName),
    emqx_exproto:stop_listener({Proto, LisType, ListenOn,
      Opts})
                end,
    Listeners).

on_module_status(_ModId, _) -> #{is_alive => true}.

grpc_server_options(ModId,
    Config = #{<<"port">> := Port, <<"ssl">> := IsSSL}) ->
  case IsSSL of
    true ->
      SSLOptions = emqx_module_utils:get_ssl_opts(Config,
        ModId),
      {Port, [{ssl, true}] ++ SSLOptions};
    _ -> {Port, [{ssl, false}]}
  end.

listeners_and_protocol_handler_options(ModId, Config) ->
  ListenerCfgs =
    emqx_module_utils:parse_proto_option(ModId, Config),
  lists:map(fun ({Proto, ListenOn, Opts}) ->
    {HandlerOpts, Opts1} = take([connection_handler_url,
      connection_handler_ssl,
      connection_handler_keyfile,
      connection_handler_certfile,
      connection_handler_cacertfile],
      Opts),
    {_, Opts2} = take([ssl, port, keyfile, certfile,
      cacertfile],
      Opts1),
    {SvrAddr, HandlerOptions} =
      handler_opts(parse_handler_options(ModId,
        HandlerOpts)),
    ChannName = channel_name(ModId, Proto, ListenOn),
    {ok, ChannPid} =
      start_grpc_protocol_handler_instance(ChannName,
        SvrAddr,
        HandlerOptions),
    {"module_exproto", Proto, ListenOn,
        Opts2 ++
        [{handler, ChannName}, {'$channel_pid', ChannPid}]}
            end,
    ListenerCfgs).

channel_name(ModId, Proto, ListenOn) ->
  lists:flatten(io_lib:format("~s-~s:~s",
    [ModId, Proto,
      emqx_module_utils:format_listenon(ListenOn)])).

parse_handler_options(ModId, Opts) ->
  Url = proplists:get_value(connection_handler_url, Opts),
  Keyfile =
    proplists:get_value(connection_handler_keyfile, Opts),
  Certfile =
    proplists:get_value(connection_handler_certfile, Opts),
  Cacertfile =
    proplists:get_value(connection_handler_cacertfile,
      Opts),
  Config = #{<<"cacertfile">> => Cacertfile,
    <<"certfile">> => Certfile, <<"keyfile">> => Keyfile},
  case http_uri:parse(binary_to_list(Url)) of
    {ok, {http, _, Host, Port, _, _}} ->
      [{scheme, http}, {host, Host}, {port, Port}];
    {ok, {https, _, Host, Port, _, _}} ->
      SSLOptions = emqx_module_utils:get_ssl_opts(Config,
        ModId),
      [{scheme, https}, {host, Host}, {port, Port},
        {ssl_options, [{ssl, true}] ++ SSLOptions}];
    _ -> error(invalid_server_options)
  end.

start_grpc_server(Name, Port, SSLOptions) ->
  Services = #{protos => [emqx_exproto_pb],
    services =>
    #{'emqx.exproto.v1.ConnectionAdapter' =>
    emqx_exproto_gsvr}},
  Options = case SSLOptions of
              [] -> [];
              _ ->
                [{ssl_options, lists:keydelete(ssl, 1, SSLOptions)}]
            end,
  {ok, _SvrSup} = grpc:start_server(Name, Port, Services,
    Options).

stop_grpc_server(Name, _SvrSup) ->
  _ =
    supervisor:terminate_child(grpcbox_services_simple_sup,
      _SvrSup),
  grpc:stop_server(Name).

start_grpc_protocol_handler_instance(ChannName, SvrAddr,
    Options) ->
  {ok, _ChannPid} =
    grpc_client_sup:create_channel_pool(ChannName, SvrAddr,
      Options).

stop_grpc_connection_handler_instance(ChannName) ->
  _ = supervisor:terminate_child(grpcbox_channel_sup,
    ChannName),
  _ = grpc_client_sup:stop_channel_pool(ChannName),
  ok.

handler_opts(Opts) ->
  Scheme = proplists:get_value(scheme, Opts),
  Host = proplists:get_value(host, Opts),
  Port = proplists:get_value(port, Opts),
  SvrAddr = lists:flatten(io_lib:format("~s://~s:~w",
    [Scheme, Host, Port])),
  ClientOpts = case Scheme of
                 https ->
                   SslOpts = lists:keydelete(ssl, 1,
                     proplists:get_value(ssl_options,
                       Opts, [])),
                   #{gun_opts =>
                   #{transport => ssl, transport_opts => SslOpts}};
                 _ -> #{}
               end,
  {SvrAddr, ClientOpts}.

take(Keys, Opts) -> take(Keys, Opts, []).

take([], Opts, Acc) -> {Acc, Opts};
take([Key | Keys], Opts, Acc) ->
  {Acc1, Opts1} = take_(Key, Opts, Acc),
  take(Keys, Opts1, Acc1).

take_(Key, Opts, Acc) ->
  case lists:keytake(Key, 1, Opts) of
    false -> {Acc, Opts};
    {value, Val, Opts1} -> {[Val | Acc], Opts1}
  end.


